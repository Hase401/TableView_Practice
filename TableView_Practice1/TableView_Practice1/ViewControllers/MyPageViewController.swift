//
//  MyPageViewController.swift
//  TableView_Practice1
//
//  Created by Èï∑Ë∞∑Â∑ùÂ≠ùÂ§™ on 2021/08/23.
//

import UIKit

final class MyPageViewController: UIViewController, UIPickerViewDelegate, UIPickerViewDataSource {

    @IBOutlet private weak var tableView: UITableView!
    @IBOutlet private weak var semiBoldButton: UIButton!

    var yearArray = [Int]() // IntÂûã„ÅÆ„Åæ„ÅæPickerView„Åß„Åç„Çã
    var monthArray = [Int]() // IntÂûã„ÅÆ„Åæ„ÅæPickerView„Åß„Åç„Çã
        // ÂâäÈô§
    //    var urudosi = [Bool]()
    var urudosi = [Int:Bool]() // ÈñèÂπ¥„Åã„Å©„ÅÜ„Åã„ÇíÊ†ºÁ¥ç„Åô„ÇãÈÖçÂàóÔºàÂπ¥„Å´ÂØæÂøúÔºâ
    var componentFiles: [[Int]] = [] // Â§âÊõ¥
    // „Äê‰øùÁïô„Äë
//    let dayName = ["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"] // ÊõúÊó•„ÅÆÈÖçÂàó
//    let days = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31] // ÂêÑÊúà„ÅÆÊó•Êï∞

    // ÂâäÈô§
//    var yearFiles: [Int] = [] // sectionTitle„Å´‰Ωø„ÅÜ // Int„Å´Â§âÊõ¥
    var yearFile: [SectionHeader] = [] // static„Çí‰Ωø„ÅÜÔºü
    var dateArray: [Date] = []

    override func viewDidLoad() {
        super.viewDidLoad()

        view.backgroundColor = .systemGray6
        self.navigationController?.navigationBar.barTintColor = UIColor(hex: "4169E1")
        self.navigationItem.title = "Ë®òÈå≤„Åô„Çã"
        navigationController?.navigationBar.prefersLargeTitles = true

        setupArray()
        setupTableView()
        setupButton()
    }

    func setupArray() {
        for i in 2020...2050 {
            yearArray.append(i)
            if i % 4 == 0 {
                if i % 100 == 0 {
                    if i % 400 == 0 {
//                        urudosi.append(true)
                        urudosi[i] = true
                    } else {
//                        urudosi.append(false)
                        urudosi[i] = false
                    }
                } else {
//                    urudosi.append(true)
                    urudosi[i] = true
                }
            } else {
//                urudosi.append(false)
                urudosi[i] = false
            }
        }
        for i in 1...12 {
            monthArray.append(i)
        }
        componentFiles = [yearArray, monthArray]
    }

    private func setupTableView() {
        tableView.register(SectionHeaderView.nib(),
                           forHeaderFooterViewReuseIdentifier: SectionHeaderView.identifier)
        tableView.delegate = self
        tableView.dataSource = self
        tableView.tableFooterView = UIView()
        yearFile = [SectionHeader(year: 2020, isCellShowed: true),
                    SectionHeader(year: 2021, isCellShowed: true)]
        yearFile.sort {$0.year > $1.year}
        dateArray = [
            Date(year: 2021, month: 5),
            Date(year: 2021, month: 4),
            Date(year: 2021, month: 3),
            Date(year: 2021, month: 2),
            Date(year: 2021, month: 1),
            Date(year: 2020, month: 12),
            Date(year: 2020, month: 11),
            Date(year: 2020, month: 10)
        ]
    }

    private func setupButton() {
        semiBoldButton.backgroundColor = UIColor(hex: "FFA500") // subColor
        semiBoldButton.layer.cornerRadius = 25
        // symbolScale = .large // storyboard„ÅßË®≠ÂÆöÊ∏à„Åø
    }

//    // ÊõúÊó•„ÇíË®àÁÆó„Åô„ÇãÈñ¢Êï∞
//    func day(year: Int, month: Int, day: Int) -> Int {
//        var years = year
//        var monthes = month
//        if month == 1 || month == 2 {
//            years -= 1
//            monthes += 12
//        }
//        let halfUp = Int(years / 100)
//        let halfDown = years - halfUp * 100
//        let m = Int(((monthes + 1) * 26) / 10)
//        let y = Int(halfDown / 4)
//        let c = Int(halfUp / 4)
//        let h = (day + m + halfDown + y + c - 2 * halfUp) % 7
//        return h
//    }
    
    static func instantiate() -> MyPageViewController {
        guard let vc = UIStoryboard(name: "FirstMyPage", bundle: nil).instantiateInitialViewController() as? MyPageViewController else {
            fatalError("MyPageViewController„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì")
        }
        return vc
    }

    @IBAction func createFileTapped(_ sender: Any) {
        let title = "Âπ¥Êúà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        let message = "\n\n\n\n\n\n\n\n" // pickerView„Çà„Çä„ÇÇÂ∫É„Åë„Çå„Å∞‰∏ÄÂøúÂïèÈ°å„Å™„ÅèÂãï„Åè
        let actionSheet = UIAlertController(title: title,
                                            message: message,
                                            preferredStyle: UIAlertController.Style.actionSheet)
        let pickerView = UIPickerView(frame: CGRect(x: 0,
                                                    y: 50,
                                                    width: actionSheet.view.bounds.width*0.955, // „Åì„Åì„Çí„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÁî®„ÅÑ„Å¶Ë®≠ÂÆö„Åó„Åü„ÅÑ„Åå„ÄÅ„ÄÅ
                                                    height: 155)) // Âêà„Çè„Åõ„Çã„ÅÆ„ÅåÈù¢ÂÄí„Åè„Åï„ÅÑ„ÄÇ„ÄÇ„ÄÇ
//        pickerView.backgroundColor = .red
        pickerView.delegate = self
        pickerView.dataSource = self
        actionSheet.view.addSubview(pickerView)

        let ok = UIAlertAction(title: "OK",
                               style: UIAlertAction.Style.default,
                               handler: { (action: UIAlertAction!) in
                                print("OKÔºÅ„Éï„Ç°„Ç§„É´„ÇíËøΩÂä†„Åó„Åæ„ÅôÔºÅ")
                                let year = self.yearArray[pickerView.selectedRow(inComponent: 0)]
                                let month = self.monthArray[pickerView.selectedRow(inComponent: 1)]
                                var isYearCommon: Bool = false
                                for i in 0...self.yearFile.count-1 {
                                    if year == self.yearFile[i].year {
                                        isYearCommon = true
                                    }
                                }
                                if !isYearCommon {
                                    let newSection = SectionHeader(year: year, isCellShowed: true)
                                    self.yearFile.append(newSection)
                                    self.yearFile.sort {$0.year > $1.year} // ÈôçÈ†Ü
                                }
                                var isMonthCommon: Bool = false
                                for i in 0...self.dateArray.count-1 {
                                    if year == self.dateArray[i].year && month == self.dateArray[i].month {
                                        isMonthCommon = true
                                    }
                                }
                                if !isMonthCommon {
                                    self.dateArray.append(Date(year: year,month: month))
                                    self.dateArray.sort {$0.month > $1.month}
                                }
                                self.tableView.reloadData()
                               })
        let close = UIAlertAction(title: "Èñâ„Åò„Çã",
                                  style: UIAlertAction.Style.cancel,
                                  handler: { (action: UIAlertAction!) in
                                    print("Èñâ„Åò„Çã")
                                  })
        actionSheet.addAction(ok)
        actionSheet.addAction(close)
        self.present(actionSheet, animated: true)
    }

    // pickerView„ÅßÂøÖÈ†à
    func numberOfComponents(in pickerView: UIPickerView) -> Int {
        componentFiles.count
    }
    func pickerView(_ pickerView: UIPickerView, numberOfRowsInComponent component: Int) -> Int {
        componentFiles[component].count
    }

    // UIPickerView„Åß‰ªªÊÑè
    func pickerView(_ pickerView: UIPickerView, titleForRow row: Int, forComponent component: Int) -> String? {
        String(componentFiles[component][row]) // String„Å´Â§âÊõ¥
    }
    func pickerView(_ pickerView: UIPickerView, didSelectRow row: Int, inComponent component: Int) {
        print(componentFiles[component][row])
    }
}

extension MyPageViewController: UITableViewDelegate {
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        50
    }

    func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        guard let sectionHeaderView = tableView.dequeueReusableHeaderFooterView(withIdentifier: SectionHeaderView.identifier) as? SectionHeaderView else {
            fatalError("sectionHeaderView„ÅåËøî„Å£„Å¶„Åç„Å¶„Åæ„Åõ„Çì")
        }
        // „Äê„Éë„Çø„Éº„É≥‚ë†„Äë‚ùå
//        sectionHeaderView.sectionNumber = section
//        sectionHeaderView.configure(sectionHeader: Self.yearFile[section], showCellButton: { [weak self] in
//            guard let strongSelf = self else { return }
//            strongSelf.tableView.beginUpdates()
//            let animation = Self.yearFile[section].isCellShowed ?
//                UITableView.RowAnimation.bottom : UITableView.RowAnimation.top
//            strongSelf.tableView.reloadRows(at: [], with: animation)
//            strongSelf.tableView.endUpdates()
//        })
        // „Äê„Éë„Çø„Éº„É≥‚ë°„Äë‚ùå
//        sectionHeaderView.configure(sectionHeader: yearFile[section], showCellButton: { [weak self] in
//            guard let strongSelf = self else { return }
//            strongSelf.tableView.beginUpdates()
//            print($0)
//            let animation = $0 ? UITableView.RowAnimation.bottom : UITableView.RowAnimation.top
//            strongSelf.tableView.reloadRows(at: [], with: animation)
////            strongSelf.tableView.reloadSections([section], with: .automatic)
//            strongSelf.tableView.endUpdates()
//        })
        // „Äê„Éë„Çø„Éº„É≥‚ë¢„Äëüî∫
        sectionHeaderView.configure(sectionHeader: yearFile[section])
        sectionHeaderView.rotateImageView(sectionHeader: yearFile[section])
        let gesture = UITapGestureRecognizer(target: self,
                                             action: #selector(headerTapped(sender:)))
        sectionHeaderView.addGestureRecognizer(gesture)
        sectionHeaderView.tag = section
        return sectionHeaderView
    }

    @objc func headerTapped(sender: UITapGestureRecognizer) {
        // tag„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅreturn
        guard let section = sender.view?.tag else {
            return
        }
        yearFile[section].isCellShowed.toggle()
        tableView.beginUpdates()
        tableView.reloadSections([section], with: .fade)
        tableView.endUpdates()
    }

}

extension MyPageViewController: UITableViewDataSource {
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        if yearFile[section].isCellShowed {
            var count: Int = 0
            for i in 0...dateArray.count-1 {
                if yearFile[section].year == dateArray[i].year {
                    count += 1
                }
            }
            return count
        } else {
            return 0
        }
    }

    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        var array: [Date] = []
        for i in 0...dateArray.count-1 {
            if yearFile[indexPath.section].year == dateArray[i].year {
                array.append(dateArray[i])
            }
        }

        let cell = tableView.dequeueReusableCell(withIdentifier: "Cell", for: indexPath)
        cell.textLabel?.text = "\(array[indexPath.row].year)"+"."+"\(array[indexPath.row].month)"
        return cell
    }

    func numberOfSections(in tableView: UITableView) -> Int {
        yearFile.count
    }

    // ÂâäÈô§
//    func tableView(_ tableView: UITableView, titleForHeaderInSection section: Int) -> String? {
//        String(yearFiles[section]) // String„Å´Â§âÊõ¥
//    }

}
